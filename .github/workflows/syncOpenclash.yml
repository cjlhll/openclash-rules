name: Sync OpenClash Releases

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´02:00è¿è¡Œ (åŒ—äº¬æ—¶é—´10:00)
    - cron: '0 2 * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

jobs:
  sync-openclash:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y wget curl jq
        mkdir -p assets temp
        
    - name: Get Latest OpenClash Release
      id: get_release
      run: |
        echo "è·å–OpenClashæœ€æ–°releaseä¿¡æ¯..."
        RELEASE_INFO=$(curl -s "https://api.github.com/repos/vernesong/OpenClash/releases/latest")
        
        if [ $? -ne 0 ] || [ -z "$RELEASE_INFO" ]; then
          echo "è·å–releaseä¿¡æ¯å¤±è´¥ï¼Œå°è¯•è·å–æ‰€æœ‰releasesçš„ç¬¬ä¸€ä¸ª..."
          RELEASE_INFO=$(curl -s "https://api.github.com/repos/vernesong/OpenClash/releases?per_page=1" | jq '.[0]')
        fi
        
        TAG_NAME=$(echo "$RELEASE_INFO" | jq -r '.tag_name')
        RELEASE_NAME=$(echo "$RELEASE_INFO" | jq -r '.name')
        RELEASE_BODY=$(echo "$RELEASE_INFO" | jq -r '.body')
        PUBLISHED_AT=$(echo "$RELEASE_INFO" | jq -r '.published_at')
        
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
        echo "published_at=$PUBLISHED_AT" >> $GITHUB_OUTPUT
        
        # ä¿å­˜release bodyåˆ°æ–‡ä»¶
        echo "$RELEASE_BODY" > temp/release_body.txt
        
        echo "æ‰¾åˆ°OpenClashç‰ˆæœ¬: $TAG_NAME"
        echo "å‘å¸ƒæ—¶é—´: $PUBLISHED_AT"
        
        # è·å–assetsä¿¡æ¯
        echo "$RELEASE_INFO" | jq -r '.assets[] | "\(.name)|\(.browser_download_url)|\(.size)"' > temp/assets_list.txt
        
        echo "Assetsåˆ—è¡¨:"
        cat temp/assets_list.txt
    
    - name: Check Existing Release
      id: check_existing
      run: |
        TAG_NAME="${{ steps.get_release.outputs.tag_name }}"
        
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒç‰ˆæœ¬çš„release
        EXISTING_RELEASE=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG_NAME" | jq -r '.tag_name // empty')
        
        if [ "$EXISTING_RELEASE" = "$TAG_NAME" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Release $TAG_NAME å·²å­˜åœ¨ï¼Œå°†æ›´æ–°assets"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Release $TAG_NAME ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°release"
        fi
    
    - name: Download Assets
      run: |
        echo "å¼€å§‹ä¸‹è½½assetsæ–‡ä»¶..."
        
        while IFS='|' read -r name url size; do
          if [[ "$name" == *.ipk ]] || [[ "$name" == *.apk ]]; then
            echo "ä¸‹è½½: $name (å¤§å°: $size bytes)"
            
            # ä½¿ç”¨wgetä¸‹è½½ï¼Œè®¾ç½®é‡è¯•å’Œè¶…æ—¶
            if wget --timeout=30 --tries=3 --continue "$url" -O "temp/$name"; then
              # éªŒè¯æ–‡ä»¶å¤§å°
              DOWNLOADED_SIZE=$(stat -c%s "temp/$name")
              if [ "$DOWNLOADED_SIZE" -eq "$size" ]; then
                echo "âœ“ $name ä¸‹è½½æˆåŠŸå¹¶éªŒè¯å®Œæ•´æ€§"
                # å¤åˆ¶åˆ°assetsç›®å½•ä¿æŒåŸå§‹æ–‡ä»¶å
                cp "temp/$name" "assets/$name"
              else
                echo "âœ— $name æ–‡ä»¶å¤§å°ä¸åŒ¹é… (æœŸæœ›: $size, å®é™…: $DOWNLOADED_SIZE)"
                exit 1
              fi
            else
              echo "âœ— $name ä¸‹è½½å¤±è´¥"
              exit 1
            fi
          else
            echo "è·³è¿‡éIPK/APKæ–‡ä»¶: $name"
          fi
        done < temp/assets_list.txt
        
        echo "æ‰€æœ‰æ–‡ä»¶ä¸‹è½½å®Œæˆ"
        ls -la assets/
    
    - name: Commit Assets to Repository
      run: |
        # é…ç½®git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥assetsç›®å½•æ˜¯å¦æœ‰å˜åŒ–
        if [ -n "$(git status --porcelain assets/)" ]; then
          git add assets/
          git commit -m "Update OpenClash assets for ${{ steps.get_release.outputs.tag_name }}
          
          - åŒæ­¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')
          - æºç‰ˆæœ¬: ${{ steps.get_release.outputs.tag_name }}
          - åŒ…å«æ–‡ä»¶: $(ls assets/ | tr '\n' ' ')
          "
          git push
          echo "Assetså·²æäº¤åˆ°ä»“åº“"
        else
          echo "Assetsç›®å½•æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        fi
    
    - name: Create or Update Release
      uses: actions/create-release@v1
      if: steps.check_existing.outputs.exists == 'false'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_release.outputs.tag_name }}
        release_name: "OpenClash ${{ steps.get_release.outputs.tag_name }}"
        body: |
          # OpenClash ${{ steps.get_release.outputs.tag_name }} åŒæ­¥ç‰ˆæœ¬
          
          **åŒæ­¥æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
          **æºä»“åº“**: [vernesong/OpenClash](https://github.com/vernesong/OpenClash)
          **æºå‘å¸ƒæ—¶é—´**: ${{ steps.get_release.outputs.published_at }}
          
          ## åŒ…å«çš„ç¼–è¯‘äº§ç‰©æ–‡ä»¶
          
          æœ¬releaseåŒ…å«ä»¥ä¸‹ä»OpenClashå®˜æ–¹ä»“åº“åŒæ­¥çš„ç¼–è¯‘äº§ç‰©ï¼š
          
          ### IPKæ–‡ä»¶ (OpenWrtåŒ…ç®¡ç†å™¨æ ¼å¼)
          - é€‚ç”¨äºOpenWrtç³»ç»Ÿçš„å®‰è£…åŒ…
          - æ–‡ä»¶ä¿å­˜åœ¨ `assets/` ç›®å½•ä¸­
          
          ### APKæ–‡ä»¶ (AlpineåŒ…ç®¡ç†å™¨æ ¼å¼)  
          - é€‚ç”¨äºAlpine Linuxç³»ç»Ÿçš„å®‰è£…åŒ…
          - æ–‡ä»¶ä¿å­˜åœ¨ `assets/` ç›®å½•ä¸­
          
          ## å®‰è£…è¯´æ˜
          
          è¯·æ ¹æ®æ‚¨çš„ç³»ç»Ÿç±»å‹é€‰æ‹©å¯¹åº”çš„æ–‡ä»¶ï¼š
          
          **OpenWrtç³»ç»Ÿ**:
          ```bash
          # ä¸‹è½½IPKæ–‡ä»¶åå®‰è£…
          opkg install /path/to/luci-app-openclash_*.ipk
          ```
          
          **Alpine Linuxç³»ç»Ÿ**:
          ```bash
          # ä¸‹è½½APKæ–‡ä»¶åå®‰è£…  
          apk add --allow-untrusted /path/to/luci-app-openclash-*.apk
          ```
          
          ## åŸå§‹å‘å¸ƒè¯´æ˜
          
          ä»¥ä¸‹æ˜¯æ¥è‡ªOpenClashå®˜æ–¹ä»“åº“çš„å‘å¸ƒè¯´æ˜ï¼š
          
          ---
          
          $(cat temp/release_body.txt)
          
        draft: false
        prerelease: false
    
    - name: Upload Assets to Release
      run: |
        TAG_NAME="${{ steps.get_release.outputs.tag_name }}"
        
        # è·å–release ID
        RELEASE_ID=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG_NAME" | jq -r '.id')
        
        if [ "$RELEASE_ID" != "null" ] && [ -n "$RELEASE_ID" ]; then
          echo "æ‰¾åˆ°release ID: $RELEASE_ID"
          
          # ä¸Šä¼ æ¯ä¸ªassetæ–‡ä»¶
          for file in assets/*.{ipk,apk}; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "ä¸Šä¼  $filename åˆ°release..."
              
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Content-Type: application/octet-stream" \
                --data-binary @"$file" \
                "https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=$filename"
              
              echo "âœ“ $filename ä¸Šä¼ å®Œæˆ"
            fi
          done
        else
          echo "æ— æ³•è·å–release ID"
          exit 1
        fi
    
    - name: Cleanup
      run: |
        rm -rf temp/
        echo "æ¸…ç†å®Œæˆ"
    
    - name: Summary
      run: |
        echo "## ğŸ‰ OpenClashåŒæ­¥å®Œæˆ!"
        echo ""
        echo "**ç‰ˆæœ¬**: ${{ steps.get_release.outputs.tag_name }}"
        echo "**åŒæ­¥æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "**åŒæ­¥çš„æ–‡ä»¶**:"
        for file in assets/*; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            size=$(stat -c%s "$file")
            echo "- $filename ($(numfmt --to=iec-i --suffix=B $size))"
          fi
        done
        echo ""
        echo "æ‰€æœ‰IPKå’ŒAPKæ–‡ä»¶å·²æˆåŠŸåŒæ­¥åˆ°ä»“åº“!"
