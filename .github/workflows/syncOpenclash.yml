---
name: Mirror OpenClash Release to Repository

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°å·²å­˜åœ¨çš„release'
        required: false
        default: 'false'
        type: boolean
  # å®šæ—¶è§¦å‘ - æ¯å¤©æ£€æŸ¥ä¸€æ¬¡
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ

jobs:
  mirror-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install dependencies
        run: |
          # ç¡®ä¿å¿…è¦å·¥å…·å·²å®‰è£…
          sudo apt-get update
          sudo apt-get install -y jq curl wget parallel
        
      - name: Get latest OpenClash release
        id: get_release
        run: |
          echo "ğŸ” æ­£åœ¨è·å–OpenClashæœ€æ–°å‘å¸ƒä¿¡æ¯..."
          
          # ä½¿ç”¨GitHub APIè·å–æœ€æ–°çš„releaseä¿¡æ¯ï¼ˆåŒ…æ‹¬pre-releaseç‰ˆæœ¬ï¼‰
          LATEST_RELEASE=$(curl -s -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/vernesong/OpenClash/releases?per_page=1" | jq '.[0]')
          
          # æ£€æŸ¥APIå“åº”æ˜¯å¦æœ‰æ•ˆ
          if [ "$LATEST_RELEASE" = "null" ] || [ -z "$LATEST_RELEASE" ]; then
            echo "âŒ é”™è¯¯: æ— æ³•è·å–å‘å¸ƒä¿¡æ¯"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºpre-release
          IS_PRERELEASE=$(echo "$LATEST_RELEASE" | jq -r '.prerelease')
          echo "ğŸ“¦ å‘ç°å‘å¸ƒç‰ˆæœ¬ - é¢„å‘å¸ƒç‰ˆæœ¬: $IS_PRERELEASE"
          
          # æå–releaseä¿¡æ¯
          TAG_NAME=$(echo "$LATEST_RELEASE" | jq -r '.tag_name')
          RELEASE_NAME=$(echo "$LATEST_RELEASE" | jq -r '.name')
          PUBLISHED_AT=$(echo "$LATEST_RELEASE" | jq -r '.published_at')
          ASSETS_COUNT=$(echo "$LATEST_RELEASE" | jq '.assets | length')
          
          # å¤„ç†release bodyï¼Œè½¬ä¹‰ç‰¹æ®Šå­—ç¬¦å’Œæ¢è¡Œç¬¦
          RELEASE_BODY_RAW=$(echo "$LATEST_RELEASE" | jq -r '.body')
          # ä½¿ç”¨base64ç¼–ç æ¥å®‰å…¨ä¼ é€’åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„å†…å®¹
          RELEASE_BODY_ENCODED=$(echo "$RELEASE_BODY_RAW" | base64 -w 0)
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "published_at=$PUBLISHED_AT" >> $GITHUB_OUTPUT
          echo "release_body_encoded=$RELEASE_BODY_ENCODED" >> $GITHUB_OUTPUT
          echo "assets_count=$ASSETS_COUNT" >> $GITHUB_OUTPUT
          
          echo "âœ… æœ€æ–°å‘å¸ƒ: $RELEASE_NAME ($TAG_NAME)"
          echo "ğŸ“… å‘å¸ƒæ—¶é—´: $PUBLISHED_AT"
          echo "ğŸ“ èµ„æºæ–‡ä»¶æ•°é‡: $ASSETS_COUNT"
          echo "ğŸ“ æè¿°é•¿åº¦: ${#RELEASE_BODY_RAW} å­—ç¬¦"
          
      - name: Check if release already exists
        id: check_release
        run: |
          echo "ğŸ” æ£€æŸ¥å‘å¸ƒç‰ˆæœ¬æ˜¯å¦å·²å­˜åœ¨..."
          
          # è·å–å½“å‰ä»“åº“çš„æ‰€æœ‰releases
          EXISTING_RELEASE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.get_release.outputs.tag_name }}")
          
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨
          if echo "$EXISTING_RELEASE" | jq -e '.id' > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "release_id=$(echo "$EXISTING_RELEASE" | jq -r '.id')" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ å‘å¸ƒç‰ˆæœ¬ ${{ steps.get_release.outputs.tag_name }} å·²å­˜åœ¨"
            echo "ğŸ†” å‘å¸ƒID: $(echo "$EXISTING_RELEASE" | jq -r '.id')"
            
            # æ£€æŸ¥æ˜¯å¦å¼ºåˆ¶æ›´æ–°
            FORCE_UPDATE="${{ github.event.inputs.force_update }}"
            if [ "$FORCE_UPDATE" = "true" ]; then
              echo "force_update=true" >> $GITHUB_OUTPUT
              echo "âš ï¸  å¼ºåˆ¶æ›´æ–°æ¨¡å¼å·²å¯ç”¨ï¼Œå°†åˆ é™¤ç°æœ‰å‘å¸ƒ"
            else
              echo "force_update=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸  è·³è¿‡æ›´æ–° - å¦‚éœ€å¼ºåˆ¶æ›´æ–°ï¼Œè¯·åœ¨æ‰‹åŠ¨è§¦å‘æ—¶å¯ç”¨ force_update é€‰é¡¹"
            fi
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "force_update=false" >> $GITHUB_OUTPUT
            echo "âœ… å‘å¸ƒç‰ˆæœ¬ ${{ steps.get_release.outputs.tag_name }} ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°å‘å¸ƒ"
          fi
          
      - name: Delete existing release if force update
        if: steps.check_release.outputs.exists == 'true' && steps.check_release.outputs.force_update == 'true'
        run: |
          echo "ğŸ—‘ï¸  æ­£åœ¨åˆ é™¤ç°æœ‰å‘å¸ƒ..."
          
          # åˆ é™¤ç°æœ‰çš„release
          curl -X DELETE \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases/${{ steps.check_release.outputs.release_id }}"
          
          if [ $? -eq 0 ]; then
            echo "âœ… ç°æœ‰å‘å¸ƒå·²åˆ é™¤"
          else
            echo "âŒ åˆ é™¤ç°æœ‰å‘å¸ƒå¤±è´¥"
            exit 1
          fi
          
          # åˆ é™¤å¯¹åº”çš„tag
          echo "ğŸ·ï¸  æ­£åœ¨åˆ é™¤ç°æœ‰æ ‡ç­¾..."
          curl -X DELETE \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/${{ steps.get_release.outputs.tag_name }}"
          
          echo "âœ… ç°æœ‰æ ‡ç­¾å·²åˆ é™¤ï¼Œå‡†å¤‡åˆ›å»ºæ–°å‘å¸ƒ"
          
      - name: Create new release with assets
        if: steps.check_release.outputs.exists == 'false' || steps.check_release.outputs.force_update == 'true'
        run: |
          echo "ğŸš€ æ­£åœ¨åˆ›å»ºæ–°çš„å‘å¸ƒç‰ˆæœ¬..."
          
          # è§£ç release body
          RELEASE_BODY=$(echo "${{ steps.get_release.outputs.release_body_encoded }}" | base64 -d)
          
          # åˆ›å»ºrelease
          RELEASE_RESPONSE=$(curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases" \
            -d "{
              \"tag_name\": \"${{ steps.get_release.outputs.tag_name }}\",
              \"name\": \"${{ steps.get_release.outputs.release_name }}\",
              \"body\": $(echo "$RELEASE_BODY" | jq -R -s .),
              \"draft\": false,
              \"prerelease\": false
            }")
          
          # æ£€æŸ¥åˆ›å»ºæ˜¯å¦æˆåŠŸ
          RELEASE_ID=$(echo "$RELEASE_RESPONSE" | jq -r '.id')
          if [ "$RELEASE_ID" = "null" ] || [ -z "$RELEASE_ID" ]; then
            echo "âŒ åˆ›å»ºå‘å¸ƒå¤±è´¥"
            echo "$RELEASE_RESPONSE" | jq .
            exit 1
          fi
          
          echo "âœ… å‘å¸ƒåˆ›å»ºæˆåŠŸï¼ŒID: $RELEASE_ID"
          echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
          
          # è·å–å‘å¸ƒä¿¡æ¯ï¼ˆåªè·å–.ipkå’Œ.apkæ–‡ä»¶ï¼‰
          RELEASE_INFO=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/vernesong/OpenClash/releases/tags/${{ steps.get_release.outputs.tag_name }}")
          
          # è·å–æ‰€æœ‰.ipkå’Œ.apkæ–‡ä»¶
          ASSETS=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | test("\\.(ipk|apk)$")) | "\(.name)|\(.browser_download_url)"')
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•å’Œassetsç›®å½•
          mkdir -p /tmp/openclash_assets
          mkdir -p assets
          cd /tmp/openclash_assets
          
          # ä¸‹è½½.ipkå’Œ.apkæ–‡ä»¶
          if [ -n "$ASSETS" ] && [ "$ASSETS" != "null" ]; then
            ASSET_COUNT=$(echo "$ASSETS" | wc -l)
            echo "ğŸ“¦ æ‰¾åˆ° $ASSET_COUNT ä¸ª.ipk/.apkæ–‡ä»¶"
            
            # å¹¶è¡Œä¸‹è½½æ‰€æœ‰æ–‡ä»¶
            echo "$ASSETS" | while IFS='|' read -r asset_name download_url; do
              echo "â¬‡ï¸  ä¸‹è½½: $asset_name"
              wget -q --timeout=30 --tries=3 "$download_url" -O "$asset_name" &
            done
            
            # ç­‰å¾…æ‰€æœ‰ä¸‹è½½å®Œæˆ
            wait
            
            # éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
            echo "ğŸ” éªŒè¯ä¸‹è½½çš„æ–‡ä»¶..."
            for file in *.ipk *.apk; do
              if [ -f "$file" ]; then
                FILE_SIZE=$(stat -c%s "$file" 2>/dev/null || echo "0")
                if [ "$FILE_SIZE" -gt 1000 ]; then
                  echo "âœ… $file (${FILE_SIZE} bytes)"
                else
                  echo "âŒ $file ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶æŸå"
                  exit 1
                fi
              fi
            done
            
            # å¤åˆ¶åŸå§‹æ–‡ä»¶åˆ°assetsç›®å½•ï¼ˆä¿æŒåŸå§‹æ–‡ä»¶åï¼‰
            echo "ğŸ“ å¤åˆ¶æ–‡ä»¶åˆ°assetsç›®å½•..."
            for file in *.ipk *.apk; do
              if [ -f "$file" ]; then
                cp "$file" "../assets/"
                echo "ğŸ“‹ å¤åˆ¶: $file -> assets/"
              fi
            done
            
            # é‡å‘½åæ–‡ä»¶ç”¨äºreleaseä¸Šä¼ ï¼ˆå»æ‰ç‰ˆæœ¬åç¼€ï¼‰
            echo "ğŸ”„ é‡å‘½åæ–‡ä»¶ç”¨äºreleaseä¸Šä¼ ..."
            for file in *.ipk *.apk; do
              if [ -f "$file" ]; then
                # æå–åŸºç¡€æ–‡ä»¶åï¼ˆå»æ‰ç‰ˆæœ¬å·ï¼‰
                if [[ "$file" == *".ipk" ]]; then
                  NEW_NAME="luci-app-openclash.ipk"
                elif [[ "$file" == *".apk" ]]; then
                  NEW_NAME="luci-app-openclash.apk"
                fi
                
                if [ "$file" != "$NEW_NAME" ]; then
                  echo "ğŸ“ é‡å‘½å: $file -> $NEW_NAME"
                  cp "$file" "$NEW_NAME"
                else
                  echo "âœ… æ–‡ä»¶åå·²æ­£ç¡®: $file"
                fi
              fi
            done
          else
            echo "âš ï¸  æœªæ‰¾åˆ°.ipk/.apkæ–‡ä»¶"
            exit 1
          fi
          
          # ç»Ÿè®¡å¤„ç†åçš„æ–‡ä»¶
          TOTAL_FILES=$(ls -1 | wc -l)
          echo "ğŸ“ å¤„ç†å®Œæˆï¼Œå…± $TOTAL_FILES ä¸ªæ–‡ä»¶"
          
          # ä¸Šä¼ é‡å‘½ååçš„æ–‡ä»¶åˆ°æ–°å‘å¸ƒ
          UPLOAD_SUCCESS=0
          UPLOAD_FAILED=0
          
          for file in *; do
            if [ -f "$file" ]; then
              echo "â¬†ï¸  ä¸Šä¼ : $file"
              
              # å°è¯•ä¸Šä¼ æ–‡ä»¶ï¼Œæœ€å¤šé‡è¯•3æ¬¡
              RETRY_COUNT=0
              UPLOAD_RESULT=1
              
              while [ $RETRY_COUNT -lt 3 ] && [ $UPLOAD_RESULT -ne 0 ]; do
                if [ $RETRY_COUNT -gt 0 ]; then
                  echo "ğŸ”„ é‡è¯•ä¸Šä¼  ($((RETRY_COUNT + 1))/3): $file"
                  sleep 2
                fi
                
                UPLOAD_RESPONSE=$(curl -s -w "%{http_code}" -X POST \
                  -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                  -H "Content-Type: application/octet-stream" \
                  --data-binary @"$file" \
                  "https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=$file")
                
                HTTP_CODE="${UPLOAD_RESPONSE: -3}"
                UPLOAD_RESULT=$?
                
                if [ "$HTTP_CODE" = "201" ] && [ $UPLOAD_RESULT -eq 0 ]; then
                  echo "âœ… $file ä¸Šä¼ æˆåŠŸ (HTTP: $HTTP_CODE)"
                  UPLOAD_SUCCESS=$((UPLOAD_SUCCESS + 1))
                  break
                else
                  echo "âš ï¸  ä¸Šä¼ å¤±è´¥ (HTTP: $HTTP_CODE, Exit: $UPLOAD_RESULT)"
                  RETRY_COUNT=$((RETRY_COUNT + 1))
                fi
              done
              
              if [ $UPLOAD_RESULT -ne 0 ] || [ "$HTTP_CODE" != "201" ]; then
                echo "âŒ $file ä¸Šä¼ æœ€ç»ˆå¤±è´¥"
                UPLOAD_FAILED=$((UPLOAD_FAILED + 1))
              fi
            fi
          done
          
          echo "ğŸ“Š ä¸Šä¼ ç»Ÿè®¡: æˆåŠŸ $UPLOAD_SUCCESS ä¸ªï¼Œå¤±è´¥ $UPLOAD_FAILED ä¸ª"
          
          if [ $UPLOAD_FAILED -gt 0 ]; then
            echo "âš ï¸  éƒ¨åˆ†æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œä½†å‘å¸ƒå·²åˆ›å»º"
            exit 0  # ä¸ä¸­æ–­å·¥ä½œæµï¼Œå…è®¸ç»§ç»­æ‰§è¡Œ
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          cd /
          rm -rf /tmp/openclash_assets
          
          # æäº¤assetsç›®å½•çš„æ›´æ”¹åˆ°ä»“åº“
          cd "$GITHUB_WORKSPACE"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ–‡ä»¶éœ€è¦æäº¤
          if [ -n "$(git status --porcelain assets/)" ]; then
            git add assets/
            git commit -m "Auto-update OpenClash assets to ${{ steps.get_release.outputs.tag_name }} - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git push
            echo "âœ… Assetsç›®å½•å·²æ›´æ–°å¹¶æ¨é€åˆ°ä»“åº“"
          else
            echo "â„¹ï¸  Assetsç›®å½•æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi
          
          echo "ğŸ‰ å‘å¸ƒåˆ›å»ºå®Œæˆï¼"
          
      - name: Skip if release exists
        if: steps.check_release.outputs.exists == 'true' && steps.check_release.outputs.force_update == 'false'
        run: |
          echo "â­ï¸  è·³è¿‡å‘å¸ƒåˆ›å»º - ç‰ˆæœ¬ ${{ steps.get_release.outputs.tag_name }} å·²å­˜åœ¨"
          
      - name: Summary
        run: |
          echo "ğŸ“Š === æ‰§è¡Œæ‘˜è¦ ==="
          echo "ğŸ·ï¸  ç‰ˆæœ¬æ ‡ç­¾: ${{ steps.get_release.outputs.tag_name }}"
          echo "ğŸ“… å‘å¸ƒæ—¶é—´: ${{ steps.get_release.outputs.published_at }}"
          echo "ğŸ“ åŒæ­¥çš„èµ„æºæ–‡ä»¶: IPKå’ŒAPKæ–‡ä»¶"
          
          if [ "${{ steps.check_release.outputs.exists }}" = "true" ] && [ "${{ steps.check_release.outputs.force_update }}" = "false" ]; then
            echo "â„¹ï¸  çŠ¶æ€: å‘å¸ƒå·²å­˜åœ¨ï¼Œæœªè¿›è¡Œæ›´æ–°"
            echo "ğŸ’¡ æç¤º: å¦‚éœ€å¼ºåˆ¶æ›´æ–°ï¼Œè¯·åœ¨æ‰‹åŠ¨è§¦å‘æ—¶å¯ç”¨ force_update é€‰é¡¹"
          elif [ "${{ steps.check_release.outputs.force_update }}" = "true" ]; then
            echo "ğŸ”„ çŠ¶æ€: å¼ºåˆ¶æ›´æ–°å®Œæˆ - å·²åŒæ­¥æ‰€æœ‰.ipk/.apkæ–‡ä»¶"
            echo "ğŸ”— æŸ¥çœ‹å‘å¸ƒ: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_release.outputs.tag_name }}"
          else
            echo "ğŸ†• çŠ¶æ€: æ–°å‘å¸ƒåˆ›å»ºå®Œæˆ - å·²åŒæ­¥æ‰€æœ‰.ipk/.apkæ–‡ä»¶"
            echo "ğŸ”— æŸ¥çœ‹å‘å¸ƒ: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_release.outputs.tag_name }}"
          fi
          
          echo "ğŸ“¦ åŸå§‹å‘å¸ƒ: https://github.com/vernesong/OpenClash/releases/tag/${{ steps.get_release.outputs.tag_name }}"
          echo "ğŸ“‹ åŒæ­¥å†…å®¹:"
          echo "  âœ… æ‰€æœ‰.ipkæ–‡ä»¶ï¼ˆåŸå§‹æ–‡ä»¶åä¿å­˜åœ¨assets/ç›®å½•ï¼‰"
          echo "  âœ… æ‰€æœ‰.apkæ–‡ä»¶ï¼ˆåŸå§‹æ–‡ä»¶åä¿å­˜åœ¨assets/ç›®å½•ï¼‰"
          echo "  âœ… luci-app-openclash.ipk (releaseä¸­å»æ‰ç‰ˆæœ¬åç¼€)"
          echo "  âœ… luci-app-openclash.apk (releaseä¸­å»æ‰ç‰ˆæœ¬åç¼€)"
          echo "  ğŸ“Š å®Œæ•´åŒæ­¥æ‰€æœ‰ç¼–è¯‘äº§ç‰©æ–‡ä»¶"

